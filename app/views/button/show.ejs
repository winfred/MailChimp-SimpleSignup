<!DOCTYPE html>
<html>
<head>
    <title>Button - MailChimp SingleSignup</title>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://s3.amazonaws.com/mc_facebook_signup_bucket/jquery.marquee.js"></script>

</head>
<body style="margin: 0 0 0 0; padding: 0 0 0 0;">
        <div id="mc-fb-signup" class="subscribe">
            <div id="fb-root"></div>
            <div id="mc_embed_signup" style="display: none" >
                <form action="/subscription" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
                    <input type="hidden" name="u" value="<%=options.u%>" /> 
                    <input type="hidden" name="id" value="<%=options.id%>" /> 
					<input type="hidden" name="opt_in" value="<%= options.opt_in %>">
                    <input type="text" value="" name="email_address"  id="mc-EMAIL"  />
                    <input type="text" name="merge_values[FNAME]" id="mc-FNAME"  value="" /> 
                    <input type="text" name="merge_values[LNAME]" id="mc-LNAME"  value="" /> 
                   
                </form>
            </div>
            <style>
			<% var style_multiplier = (options.style == 'cozy' ? 1.5 : 1); 
				options.fontsize = options.fontsize || 16;
			%>
            
            
            .subscribe
            {
                background: #<%= options.bg_color || "5F78AB"%>;
                border-radius: 4px;
                border-bottom: solid 1px #1A356E;
                color: white;
                overflow: hidden;
				height: <%= (Number(options.fontsize)+4) * style_multiplier %>px;
				text-decoration: none;
				 
				 <% //lazy font-bank
					var fonts = {};
					fonts.lucida = "'lucida grande',tahoma,verdana,arial,sans-serif";
					fonts.tahoma = "tahoma,arial,sans-serif";
					fonts.verdana = "verdana,geneva,sans-serif";
					fonts.arial = "arial,sans-serif";
					%>
                font-family: 
					<%=( options.font ? (fonts[options.font] || fonts.lucida) : fonts.lucida )%>;
				font-size: <%= options.fontsize  %>px;
                font-weight: bold;
                text-shadow: none; 
   
            }
			#facebook_logo{
				position: absolute;
			}
			
            .button{
                cursor: pointer;
                color: #<%= options.color || "FFFFFF" %>;
				overflow: hidden;
				<% if(options.facebook_logo != "false") {%>
                margin-left: <%= (Number(options.fontsize)+5) * style_multiplier  %>px;
				<% } %>
				
				
                
            }
			
			.centered  {
				<% if (options.style =="cozy"){ %>
				vertical-align: <%= (options.fontsize > 26 ? 'top' : 'middle') %>;
				padding-top: <%= (options.fontsize / 5)+'px' %>;	
				<% } %>
				padding-left: 4px;
				//

			}
			
			
            
            </style>
            
            <div class="subscribe" data-prompt="<%=options.signup_prompt%>">
				<% if(options.facebook_logo != "false") {%>
					<img src="http://s3.amazonaws.com/mc_facebook_signup_bucket/F_icon.svg"
						height="<%= (Number(options.fontsize)+4) * style_multiplier %>"
						width="<%= (Number(options.fontsize)+4) * style_multiplier%>" id="facebook_logo"></img>		
				<% } %>
			
                <marquee behavior="<%= (options.still != 'true' ? 'scroll' : 'slide')%>" scrollamount="<%= (options.fontsize  >= 22 ? '2' : '1')%>" direction="left" 
				width="<%=(options.width ? 
				(Number(options.width)-Number(options.fontsize)-4) : '150')%>" 
				height="<%=Number(options.fontsize) * 
					style_multiplier %>"
				style="display:inline;
					height: <%= (Number(options.fontsize) * style_multiplier)%>px;"
						class="button">
				 <% if (options.still == 'true') {%>
				 <div style="margin-left: <%= options.facebook_logo != 'false' ? 
						(((Number(options.fontsize)+6) * style_multiplier)+'px') : '0' %>;
						
				"><% }%><span class="centered"><%=options.signup_prompt%></span>
				<% if (options.still == 'true') {%>
				</div>
				<% }%>
				</marquee>
				
            </div>
            <script type="text/javascript">
               window.fbAsyncInit = function() {
                   FB.init({
                       appId: <%= server.facebook_appid %> ,
                       status: false,
                       // check login status
                       cookie: true,
                       // enable cookies to allow the server to access the session
                       xfbml: false,
                       // parse XFBML
                       //channelURL : 'http://localhost:3001/channel.html', // channel.html file
                       oauth: true // enable OAuth 2.0
                   });
               };
               (function() {
                   var e = document.createElement('script');
                   e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
                   e.async = true;
                   document.getElementById('fb-root').appendChild(e);
               }());
                $(document).ready(function() {
					<% if(options.still != 'true') {%>
						enableScroll();
					<% } %>
                    $(document).mousedown(connectFacebook);
					<% if (options.style == 'cozy') {%>
						cozyPadding();
						<%  }%>
                });
				var connectFacebook = function() {
					
					$(".centered").text("loading...");
                    FB.login(function(response) {
                        if (response.authResponse) {
                            gatherInfo(subscribe);
                        }
                        else {
                            console.log('User cancelled login or did not fully authorize.');
                        }
                    }, {
                        scope: 'email'
                    });
                }
                var gatherInfo = function(postCallback) {
                        console.log('Welcome!  Fetching your information.... ');
                        FB.api('/me', function(response) {
                            console.log('Good to see you, ' + response.name + '. '+response.email);
                            $("#mc-EMAIL").val(response.email);
                            $("#mc-FNAME").val(response.first_name);
                            $("#mc-LNAME").val(response.last_name);
                            postCallback(displayResponse);
                        });
                    };
                var subscribe = function(displayCallback){
 					$.post("/subscription",
						$('#mc-embedded-subscribe-form').serialize(),
						displayCallback,'json');       
                };
                var displayResponse = function(data, textStatus, jqXHR){
                    if (data.result.error){
                        //TODO: FULL ERROR HANDLING
                        if(data.result.code == 214){
                          $(".centered").text("Already subscribed with "+data.email_address);  
                        }
                        else{
                          $(".centered").html(data.result.error);  
                        }
						console.log(data.result);
                     
                    }else{
						var response;
						<% if(options.opt_in == "single") { %>
							response = "Thank you for subscribing with " + data.email_address;
						<% } else { %>
                      		response = "Thank you! Check for confirmation at " + data.email_address;  
 						<% } %>
						console.log(response);
						$(".centered").text(response);						
                    }
					<% if (options.style == 'cozy' ) {%>   
						cozyPadding();
					<% } %>
					enableScroll();
					
                };
				var enableScroll = function(){
					
					$('marquee').attr('behavior','scroll')
					.marquee('button');
					
				}
				//because I don't know CSS well enough 
				//or jquery.marquee has limited me since height attributes don't apply to <marquee>
				var cozyPadding = function(){
					
					$($('.button div:first-child')[0]).css('padding-top','<%= 
						(options.fontsize / (options.fontsize > 24 ? 6 : 4))
						+'px' %>' );
				}
            </script>
        </div>


